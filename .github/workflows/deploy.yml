name: Deploy VRWEB to GitHub Pages
on:
  push:
    branches:
      - main
jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3
        
      - name: Fix Unity WebGL files
        run: |
          # Sửa đường dẫn trong index.html
          sed -i 's/href="TemplateData\//href="\.\/TemplateData\//g' WEB/index.html
          sed -i 's/var buildUrl = "Build";/var buildUrl = "\.\/Build";/g' WEB/index.html
          sed -i 's/streamingAssetsUrl: "StreamingAssets"/streamingAssetsUrl: "\.\/StreamingAssets"/g' WEB/index.html
          
          # Quan trọng: Xóa phần mở rộng .br từ URL trong index.html
          sed -i 's/WEB.data.br/WEB.data/g' WEB/index.html
          sed -i 's/WEB.framework.js.br/WEB.framework.js/g' WEB/index.html
          sed -i 's/WEB.wasm.br/WEB.wasm/g' WEB/index.html
          
          # Kiểm tra xem có tệp .br không và giải nén chúng
          if [ -f "WEB/Build/WEB.data.br" ]; then
            apt-get update && apt-get install -y brotli
            brotli -d WEB/Build/WEB.data.br -o WEB/Build/WEB.data
            brotli -d WEB/Build/WEB.framework.js.br -o WEB/Build/WEB.framework.js
            brotli -d WEB/Build/WEB.wasm.br -o WEB/Build/WEB.wasm
            # Xóa các file .br sau khi giải nén
            rm WEB/Build/WEB.data.br
            rm WEB/Build/WEB.framework.js.br
            rm WEB/Build/WEB.wasm.br
          fi
          
          # Thêm file .nojekyll
          touch WEB/.nojekyll
        
      - name: Verify WEB directory content
        run: ls -la WEB/Build
        
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: WEB
          branch: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
          clean: true
